---

---

<div class="time-panel" id="time-panel">
    <div class="time-header">
        <h4 class="time-title" id="time-title">Selecciona una hora</h4>

        <div class="format-toggle" id="format-toggle">
            <button class="toggle-btn active" data-format="24h">24h</button>
            <button class="toggle-btn" data-format="12h">12h</button>
        </div>
    </div>

    <div id="slots-loader" class="loader hidden">
        <div class="spinner"></div>
        <p>Buscando horas...</p>
    </div>

    <div id="slots-container" class="slots-grid">
        <!-- Populated by JS -->
    </div>

    <div id="empty-slots" class="empty-state hidden">
        <p>No quedan horarios disponibles para hoy.</p>
        <span style="font-size: 0.8em; opacity: 0.7;"
            >Intenta seleccionar otro día en el calendario.</span
        >
    </div>

    <div id="initial-state" class="empty-state">
        <p>Selecciona un día en el calendario.</p>
    </div>
</div>

<style>
    .time-panel {
        width: 100%;
        animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        flex-direction: column;
        padding: 0.5rem;
    }

    .time-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
    }

    .time-title {
        font-family: inherit;
        font-size: 1.25rem;
        font-weight: 800;
        margin-bottom: 0;
        color: var(--color-secondary, #1a1a1a);
        letter-spacing: -0.01em;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .format-toggle {
        display: flex;
        background: var(--color-subtle, #f5f5f5);
        padding: 0.25rem;
        border-radius: 10px;
        border: 1px solid var(--color-line, #eee);
    }

    .toggle-btn {
        padding: 0.35rem 0.75rem;
        border-radius: 8px;
        border: none;
        background: transparent;
        font-size: 0.75rem;
        font-weight: 700;
        cursor: pointer;
        color: var(--color-muted, #888);
        transition: all 0.2s ease;
    }

    .toggle-btn.active {
        background: var(--color-surface, #fff);
        color: var(--color-accent, #000);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .time-title::before {
        content: "";
        display: block;
        width: 4px;
        height: 24px;
        background: var(--color-accent, #333);
        border-radius: 2px;
    }

    /* Grid Layout */
    .slots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.75rem;
        max-height: 450px;
        overflow-y: auto;
        padding: 0.25rem;
    }

    /* Scrolled Grid Scrollbar */
    .slots-grid::-webkit-scrollbar {
        width: 4px;
    }
    .slots-grid::-webkit-scrollbar-thumb {
        background-color: var(--color-line, #eee);
        border-radius: 4px;
    }

    /* Loader */
    .loader {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
        color: var(--color-muted, #888);
        gap: 1rem;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--color-line, rgba(0, 0, 0, 0.1));
        border-top-color: var(--color-accent, #000);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    /* Empty States */
    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        background: var(--color-subtle, #f9f9f9);
        border: 1px dashed var(--color-line, #e5e5e5);
        border-radius: 16px;
        color: var(--color-muted, #666);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
    }

    .hidden {
        display: none !important;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (min-width: 768px) {
        /* .time-panel {
            padding-left: 2rem;
            border-left: 1px solid var(--color-line, #eee);
        } */

        .slots-grid {
            /* On desktop, keep 2 columns for cleaner look */
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>

<style is:global>
    /* Robust Button Styles for Dynamic Elements */
    .time-btn {
        appearance: none;
        width: 100%;
        padding: 0.875rem 0.5rem;
        background-color: var(--color-surface, #ffffff);
        border: 1px solid var(--color-line, #e5e5e5);
        border-radius: 12px;

        /* Text */
        color: var(--color-secondary, #1a1a1a);
        font-family: inherit;
        font-size: 1rem;
        font-weight: 600;
        text-align: center;

        /* Interaction */
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        position: relative;
        overflow: hidden;

        /* Flex for icon alignment if needed */
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    /* Hover */
    .time-btn:not(:disabled):hover {
        border-color: var(--color-accent, #000);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        color: var(--color-accent, #000);
        background-color: var(
            --color-surface,
            #ffffff
        ); /* Ensure bg stays clean */
        z-index: 2;
    }

    /* Active/Selected */
    .time-btn.selected {
        background-color: var(--color-accent, #000) !important;
        color: var(--color-on-accent, #ffffff) !important;
        border-color: var(--color-accent, #000) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        font-weight: 700;
    }

    /* Focus (Accessibility) */
    .time-btn:focus-visible {
        outline: 2px solid var(--color-accent, #000);
        outline-offset: 2px;
    }
</style>

<script>
    import type { BookingState } from "./booking.types";
    import {
        bookingStore,
        fetchSlotsForDate,
        setSelectedTime,
        setStep,
        setTimeFormat,
    } from "./booking.store";

    const container = document.getElementById("slots-container");
    const loader = document.getElementById("slots-loader");
    const empty = document.getElementById("empty-slots");
    const initial = document.getElementById("initial-state");
    const title = document.getElementById("time-title");
    const formatToggle = document.getElementById("format-toggle");

    let currentSlots: any[] = [];
    let currentSelectedDate: string | null = null;

    // Toggle logic
    formatToggle?.querySelectorAll(".toggle-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
            const format = btn.getAttribute("data-format") as "12h" | "24h";
            setTimeFormat(format);

            // UI update
            formatToggle
                .querySelectorAll(".toggle-btn")
                .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
        });
    });

    bookingStore.subscribe(async (state: BookingState) => {
        // Detect date change or format change
        const formatChanged = true; // We always re-render if store says so to keep it simple,
        // or we can optimize. For now, let's just listen.

        if (state.selectedDate !== currentSelectedDate) {
            currentSelectedDate = state.selectedDate;

            if (!currentSelectedDate) {
                showInitial();
                return;
            }

            showLoader();
            title!.textContent = `Horarios para ${currentSelectedDate}`;

            try {
                currentSlots = await fetchSlotsForDate(currentSelectedDate);
                renderSlots(currentSlots, state.timeFormat);
            } catch (e) {
                console.error(e);
            }
        } else {
            // If only format changed, re-render current slots
            renderSlots(currentSlots, state.timeFormat);
        }
    });

    function showLoader() {
        loader?.classList.remove("hidden");
        container!.innerHTML = "";
        empty?.classList.add("hidden");
        initial?.classList.add("hidden");
    }

    function showInitial() {
        initial?.classList.remove("hidden");
        container!.innerHTML = "";
        loader?.classList.add("hidden");
        empty?.classList.add("hidden");
        title!.textContent = "Selecciona una hora";
    }

    function formatTime(startTime: string, format: "12h" | "24h") {
        const time24 = startTime.split("T")[1].substring(0, 5);
        if (format === "24h") return time24;

        const [hours, minutes] = time24.split(":").map(Number);
        const period = hours >= 12 ? "PM" : "AM";
        const hours12 = hours % 12 || 12;
        return `${hours12}:${String(minutes).padStart(2, "0")} ${period}`;
    }

    function renderSlots(slots: any[], format: "12h" | "24h") {
        loader?.classList.add("hidden");
        container!.innerHTML = "";

        if (slots.length === 0) {
            if (currentSelectedDate) empty?.classList.remove("hidden");
            return;
        }

        slots.forEach((slot) => {
            const btn = document.createElement("button");
            btn.className = "time-btn";

            const timeStr24 = slot.startTime.split("T")[1].substring(0, 5);
            const timeDisplay = formatTime(slot.startTime, format);

            btn.textContent = timeDisplay;

            btn.addEventListener("click", () => {
                setSelectedTime(timeStr24); // Store always in 24h
                setStep(2); // Advance to form
            });

            container?.appendChild(btn);
        });
    }
</script>
