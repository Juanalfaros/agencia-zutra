---

---

<div class="booking-flow">
    <!-- Progress Header -->
    <div class="booking-steps">
        <div class="step active" data-step="1">
            <span class="step-num">1</span>
            <span class="step-label">Selección</span>
        </div>
        <div class="step-line"></div>
        <div class="step" data-step="2">
            <span class="step-num">2</span>
            <span class="step-label">Datos</span>
        </div>
    </div>

    <!-- Step 1: Selection (Calendar + Hours) -->
    <div class="booking-view active" id="view-1">
        <div class="selection-container">
            <div class="calendar-panel">
                <div class="calendar-header">
                    <button
                        class="cal-nav"
                        id="prev-month"
                        aria-label="Mes anterior"
                        ><i class="ph ph-caret-left"></i></button
                    >
                    <h3 class="current-month" id="month-display">...</h3>
                    <button
                        class="cal-nav"
                        id="next-month"
                        aria-label="Siguiente mes"
                        ><i class="ph ph-caret-right"></i></button
                    >
                </div>

                <div class="calendar-grid" id="calendar-grid">
                    <!-- Populated by JS -->
                </div>
                <p class="cal-hint">
                    Días en <span class="text-accent">blanco</span> están disponibles.
                </p>
            </div>

            <div class="time-panel" id="time-panel">
                <h4 class="view-title" id="time-panel-title">
                    Selecciona una fecha
                </h4>

                <div id="time-slots-container" class="hidden">
                    <div class="time-grid">
                        {
                            [
                                "09:00",
                                "10:30",
                                "12:00",
                                "15:00",
                                "16:30",
                                "18:00",
                            ].map((time) => (
                                <button class="time-slot" data-time={time}>
                                    {time}
                                </button>
                            ))
                        }
                    </div>
                </div>

                <div id="no-times-message" class="empty-state hidden">
                    <i class="ph ph-calendar-x"></i>
                    <p>No hay disponibilidad para este día.</p>
                </div>

                <div id="initial-message" class="empty-state">
                    <i class="ph ph-hand-pointing"></i>
                    <p>
                        Selecciona un día disponible en el calendario para ver
                        horarios.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Details Form -->
    <div class="booking-view" id="view-2">
        <form class="details-form" id="booking-final-form">
            <h4 class="view-title">Confirmar Reserva</h4>
            <div class="summary-box">
                <i class="ph-duotone ph-calendar-check"></i>
                <div class="summary-text">
                    <p id="summary-datetime">...</p>
                    <span>Llamada de Estrategia (45 min)</span>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="b-name">Nombre Completo</label>
                    <input
                        type="text"
                        id="b-name"
                        placeholder="Ej: Juan Pérez"
                        required
                    />
                </div>

                <div class="form-group">
                    <label for="b-email">Email Corporativo</label>
                    <input
                        type="email"
                        id="b-email"
                        placeholder="email@empresa.com"
                        required
                    />
                </div>

                <div class="form-group full-width">
                    <label for="b-company">Empresa / Proyecto</label>
                    <input
                        type="text"
                        id="b-company"
                        placeholder="Nombre de tu negocio"
                    />
                </div>
            </div>

            <div class="form-actions">
                <button
                    type="button"
                    class="button button--secondary back-btn"
                    data-to="1">Atrás</button
                >
                <button type="submit" class="button button--primary"
                    >Confirmar Reserva</button
                >
            </div>
        </form>
    </div>
</div>

<style>
    .booking-flow {
        padding: 0.5rem;
    }

    /* Steps indicator */
    .booking-steps {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 2.5rem;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        opacity: 0.4;
        transition: all 0.3s ease;
    }

    .step.active {
        opacity: 1;
    }

    .step.completed {
        opacity: 1;
        color: var(--color-accent);
    }

    .step-num {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--color-subtle);
        border: 1px solid var(--color-line);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 0.875rem;
    }

    .step.active .step-num {
        background: var(--color-accent);
        color: white;
        border-color: var(--color-accent);
        box-shadow: 0 0 15px rgba(var(--color-accent-rgb), 0.3);
    }

    .step.completed .step-num {
        background: var(--color-accent-subtle);
        color: var(--color-accent);
        border-color: var(--color-accent);
    }

    .step-label {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .step-line {
        height: 1px;
        width: 40px;
        background: var(--color-line);
        margin-bottom: 1.5rem;
    }

    /* Views visibility */
    .booking-view {
        display: none;
        animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    .booking-view.active {
        display: block;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* Selection Layout (Calendar + Hours) */
    .selection-container {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    @media (min-width: 768px) {
        .selection-container {
            flex-direction: row;
            align-items: flex-start;
        }

        .calendar-panel {
            flex: 1.2;
            padding-right: 2rem;
            border-right: 1px solid var(--color-line);
        }

        .time-panel {
            flex: 0.8;
            padding-left: 2rem;
            border-left: none; /* Removed redundant border-left */
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.4s ease forwards;
        }
    }

    /* Mobile adjustments for time panel when stacked */
    @media (max-width: 767px) {
        .time-panel {
            padding-top: 2rem;
            border-top: 1px solid var(--color-line);
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
        }
    }

    .time-panel-title {
        margin-bottom: 2rem !important;
        font-weight: 800;
        color: var(--color-secondary);
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 3rem 1.5rem;
        background: var(--color-subtle);
        border: 1px dashed var(--color-line);
        border-radius: 16px;
        color: var(--color-muted);
        flex: 1;
        gap: 1rem;
    }

    .empty-state i {
        font-size: 2.5rem;
        color: var(--color-accent);
        opacity: 0.6;
    }

    .empty-state p {
        font-size: 0.95rem;
        font-weight: 500;
        line-height: 1.4;
    }

    .hidden {
        display: none !important;
    }

    .calendar-panel {
        width: 100%;
    }

    /* Form Grid */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.25rem;
    }

    @media (min-width: 640px) {
        .form-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        .form-group.full-width {
            grid-column: span 2;
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Calendar Container (Static part) */
    .calendar-container {
        border: none;
        padding: 0;
        background: transparent;
    }

    .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2.5rem;
        padding: 0.5rem;
        background: var(--color-subtle);
        border-radius: 16px;
    }

    .current-month {
        font-family: "Outfit", sans-serif;
        font-size: 1.15rem;
        font-weight: 800;
        color: var(--color-secondary);
        letter-spacing: -0.01em;
        text-transform: capitalize;
    }

    .cal-nav {
        background: var(--color-surface);
        border: 1px solid var(--color-line);
        color: var(--color-secondary);
        width: 38px;
        height: 38px;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .cal-nav:hover {
        background: var(--color-accent);
        color: white;
        border-color: var(--color-accent);
        transform: translateY(-1px);
    }

    .cal-hint {
        margin-top: 2.5rem;
        font-size: 0.8rem;
        color: var(--color-muted);
        text-align: center;
        font-weight: 500;
        letter-spacing: 0.02em;
    }

    /* Time Styles */
    .view-title {
        font-size: 1.25rem;
        font-weight: 800;
        margin-bottom: 1.5rem;
        text-align: center;
        color: var(--color-secondary);
    }

    .time-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin-bottom: 2rem;
    }

    .time-slot {
        padding: 1rem;
        background: var(--color-subtle);
        border: 1px solid var(--color-line);
        border-radius: 12px;
        color: var(--color-secondary);
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .time-slot:hover {
        border-color: var(--color-accent);
        background: var(--color-accent-subtle);
        color: var(--color-accent);
    }

    .back-btn {
        background: none;
        border: none;
        color: var(--color-muted);
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 1rem auto 0;
    }

    .back-btn:hover {
        color: var(--color-accent);
    }

    /* Form Styles */
    .summary-box {
        background: var(--color-accent-subtle);
        border: 1px solid var(--color-accent-subtle);
        border-radius: 16px;
        padding: 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .summary-box i {
        font-size: 2rem;
        color: var(--color-accent);
    }

    .summary-text p {
        font-weight: 800;
        color: var(--color-secondary);
        margin: 0;
    }

    .summary-text span {
        font-size: 0.875rem;
        color: var(--color-muted);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-size: 0.875rem;
        font-weight: 700;
        color: var(--color-secondary);
        margin-bottom: 0.5rem;
    }

    .form-group input {
        width: 100%;
        padding: 0.75rem 1rem;
        background: var(--color-subtle);
        border: 1px solid var(--color-line);
        border-radius: 10px;
        color: var(--color-secondary);
        transition: border-color 0.2s ease;
    }

    .form-group input:focus {
        outline: none;
        border-color: var(--color-accent);
    }

    .form-actions {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 1rem;
        margin-top: 2rem;
    }
</style>

<style is:global>
    /* Global Styles for Dynamic Calendar Grid */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.25rem;
        text-align: center;
        margin-top: 1rem;
    }

    .calendar-grid .day-name {
        font-family: "Outfit", sans-serif;
        font-size: 0.75rem;
        font-weight: 800;
        color: var(--color-muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        padding-bottom: 1rem;
        opacity: 0.5;
    }

    .day-btn {
        aspect-ratio: 1;
        width: 100%;
        max-width: 44px;
        margin: 0 auto;
        border: none !important;
        border-radius: 50% !important;
        background: transparent !important;
        color: var(--color-muted);
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        outline: none;
        appearance: none;
    }

    .day-btn.available {
        color: var(--color-secondary);
        background: transparent !important;
    }

    .day-btn.available:hover {
        background: var(--color-subtle) !important;
        color: var(--color-accent) !important;
        transform: scale(1.1);
    }

    .day-btn.selected {
        background: var(--color-accent) !important;
        color: var(--color-on-accent) !important;
        font-weight: 900;
        transform: scale(1.1);
    }

    .day-btn.today {
        border: 2px solid var(--color-accent) !important;
        color: var(--color-accent) !important;
    }

    .day-btn.disabled {
        opacity: 0.1 !important;
        cursor: not-allowed;
        background: transparent !important;
    }

    .day.empty {
        aspect-ratio: 1;
    }

    /* Fix for the SVG height: auto error */
    svg {
        height: 1em !important;
    }
</style>

<script>
    function initBooking() {
        let state = {
            step: 1,
            currentDate: new Date(),
            selectedDay: "",
            selectedMonth: "",
            selectedYear: "",
            time: "",
        };

        const steps = document.querySelectorAll(".step");
        const views = document.querySelectorAll(".booking-view");
        const grid = document.getElementById("calendar-grid");
        const monthDisplay = document.getElementById("month-display");
        const timePanelTitle = document.getElementById("time-panel-title");
        const slotsContainer = document.getElementById("time-slots-container");
        const noTimesMsg = document.getElementById("no-times-message");
        const initialMsg = document.getElementById("initial-message");

        const updateTimePanel = (day: string, available: boolean) => {
            if (!day) {
                if (initialMsg) initialMsg.classList.remove("hidden");
                if (slotsContainer) slotsContainer.classList.add("hidden");
                if (noTimesMsg) noTimesMsg.classList.add("hidden");
                if (timePanelTitle)
                    timePanelTitle.textContent = "Selecciona una fecha";
                return;
            }

            if (initialMsg) initialMsg.classList.add("hidden");
            if (timePanelTitle)
                timePanelTitle.textContent = `Horas para el ${day} de ${state.selectedMonth}`;

            if (available) {
                if (slotsContainer) slotsContainer.classList.remove("hidden");
                if (noTimesMsg) noTimesMsg.classList.add("hidden");
            } else {
                if (slotsContainer) slotsContainer.classList.add("hidden");
                if (noTimesMsg) noTimesMsg.classList.remove("hidden");
            }
        };

        const goToStep = (num: number) => {
            state.step = num;
            steps.forEach((s) => {
                const el = s as HTMLElement;
                const sNum = parseInt(el.dataset.step || "0");
                el.classList.toggle("active", sNum === num);
                el.classList.toggle("completed", sNum < num);
            });
            views.forEach((v) => {
                v.classList.toggle("active", v.id === `view-${num}`);
            });
        };

        const renderCalendar = () => {
            if (!grid || !monthDisplay) return;

            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();

            const monthNames = [
                "Enero",
                "Febrero",
                "Marzo",
                "Abril",
                "Mayo",
                "Junio",
                "Julio",
                "Agosto",
                "Septiembre",
                "Octubre",
                "Noviembre",
                "Diciembre",
            ];
            monthDisplay.textContent = `${monthNames[month]} ${year}`;

            // Clear and add headers
            grid.innerHTML = "";
            ["Lu", "Ma", "Mi", "Ju", "Vi", "Sa", "Do"].forEach((d) => {
                const dayName = document.createElement("div");
                dayName.className = "day-name";
                dayName.textContent = d;
                grid.appendChild(dayName);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const startingDay = firstDay === 0 ? 6 : firstDay - 1;
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < startingDay; i++) {
                const empty = document.createElement("div");
                empty.className = "day empty";
                grid.appendChild(empty);
            }

            const today = new Date();
            const isThisMonth =
                today.getMonth() === month && today.getFullYear() === year;
            let autoSelectedBtn: HTMLButtonElement | null = null;

            for (let i = 1; i <= daysInMonth; i++) {
                const btn = document.createElement("button");
                const dayDate = new Date(year, month, i);
                const dayOfWeek = dayDate.getDay();
                const isAvailable = dayOfWeek >= 2 && dayOfWeek <= 4;

                btn.className = "day-btn";
                if (isAvailable) btn.classList.add("available");
                else btn.classList.add("disabled");

                const isToday = isThisMonth && i === today.getDate();
                if (isToday) {
                    btn.classList.add("today");
                    if (isAvailable) autoSelectedBtn = btn;
                }

                btn.textContent = i.toString();
                btn.dataset.day = i.toString();

                btn.addEventListener("click", () => {
                    grid.querySelectorAll(".day-btn").forEach((b) =>
                        b.classList.remove("selected"),
                    );
                    btn.classList.add("selected");

                    state.selectedDay = i.toString();
                    state.selectedMonth = monthNames[month];
                    state.selectedYear = year.toString();

                    updateTimePanel(state.selectedDay, isAvailable);
                });
                grid.appendChild(btn);
            }

            // Auto-select today if it's available and we haven't selected anything yet
            if (autoSelectedBtn && !state.selectedDay) {
                autoSelectedBtn.click();
            } else if (!state.selectedDay) {
                updateTimePanel("", false);
            }
        };

        // Nav
        document.getElementById("prev-month")?.addEventListener("click", () => {
            state.currentDate.setMonth(state.currentDate.getMonth() - 1);
            renderCalendar();
        });
        document.getElementById("next-month")?.addEventListener("click", () => {
            state.currentDate.setMonth(state.currentDate.getMonth() + 1);
            renderCalendar();
        });

        // Time selection advances to Step 2
        document.querySelectorAll(".time-slot").forEach((slot) => {
            slot.addEventListener("click", () => {
                const el = slot as HTMLElement;
                state.time = el.dataset.time || "";
                const summary = document.getElementById("summary-datetime");
                if (summary)
                    summary.textContent = `${state.selectedDay} de ${state.selectedMonth} a las ${state.time}`;
                goToStep(2);
            });
        });

        // Back
        document.querySelectorAll(".back-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
                const el = btn as HTMLElement;
                goToStep(parseInt(el.dataset.to || "1"));
            });
        });

        // Final submit
        const form = document.getElementById(
            "booking-final-form",
        ) as HTMLFormElement;
        if (form) {
            form.addEventListener("submit", (e) => {
                e.preventDefault();
                alert(
                    `¡Reserva completada para el ${state.selectedDay} de ${state.selectedMonth} a las ${state.time}!`,
                );
                window.location.reload();
            });
        }

        renderCalendar();
    }

    initBooking();
    document.addEventListener("astro:after-swap", initBooking);
</script>
