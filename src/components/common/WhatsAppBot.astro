---
// src/components/common/WhatsAppBot.astro
interface Props {
    phone?: string;
}

const { phone = "+56942009050" } = Astro.props;
---

<!-- Trigger Button -->
<button
    class="whatsapp-float wp-trigger"
    aria-label="Abrir chat de WhatsApp"
    id="wa-trigger-btn"
>
    <div class="whatsapp-icon">
        <i class="ph-fill ph-whatsapp-logo"></i>
        <span class="notification-badge" id="wa-notification-badge">1</span>
    </div>
    <span class="whatsapp-tooltip">Chat con Zutra</span>
</button>

<!-- Chat Widget -->
<div
    id="wa-bot-widget"
    class="wa-bot-widget"
    data-phone={phone}
    aria-hidden="true"
>
    <!-- Header -->
    <div class="wa-bot-header">
        <div class="wa-bot-profile">
            <div class="profile-img">
                <svg
                    id="Capa_1"
                    xmlns="http://www.w3.org/2000/svg"
                    version="1.1"
                    viewBox="0 0 32 32"
                    style="width: 1.5rem; height: 1.5rem; fill: currentColor;"
                >
                    <style>
                        .st0 {
                            isolation: isolate;
                            opacity: 0.2;
                        }
                    </style>
                    <path
                        class="st0"
                        d="M25,7H7c-1.7,0-3,1.3-3,3v14c0,1.7,1.3,3,3,3h18c1.7,0,3-1.3,3-3v-14c0-1.7-1.3-3-3-3Z"
                    ></path>
                    <path
                        d="M25,6h-8V2c0-.6-.4-1-1-1s-1,.4-1,1v4H7c-2.2,0-4,1.8-4,4v14c0,2.2,1.8,4,4,4h18c2.2,0,4-1.8,4-4v-14c0-2.2-1.8-4-4-4ZM27,24c0,1.1-.9,2-2,2H7c-1.1,0-2-.9-2-2v-14c0-1.1.9-2,2-2h18c1.1,0,2,.9,2,2v14ZM10.1,14.3c0-.8.7-1.5,1.5-1.5s1.5.7,1.5,1.5-.7,1.5-1.5,1.5-1.5-.7-1.5-1.5ZM13.1,13.3c0,.6-.4,1-1,1h-3c-.6,0-1-.4-1-1s.4-1,1-1h3c.6,0,1,.4,1,1ZM20.2,14.3c0-.8.7-1.5,1.5-1.5s1.5.7,1.5,1.5-.7,1.5-1.5,1.5-1.5-.7-1.5-1.5ZM23.2,13.3c0,.6-.4,1-1,1h-3c-.6,0-1-.4-1-1s.4-1,1-1h3c.6,0,1,.4,1,1ZM17.7,19c0-1.4-1.1-2.4-2.5-2.4s-1,.4-1,1,.4,1,1,1,.5.2.5.4-.2.5-.5.5c-.6,0-1,.4-1,1s.4,1,1,1,.5.2.5.5-.2.4-.5.4c-.6,0-1,.4-1,1s.4,1,1,1c1.4,0,2.5-1.1,2.5-2.4s-.2-1-.5-1.5c.3-.4.5-.9.5-1.5Z"
                    ></path>
                </svg>
            </div>
            <div>
                <h4>El Zutro</h4>
                <p>Tu asistente virtual</p>
            </div>
        </div>
        <div class="wa-bot-actions">
            <button
                id="wa-reset-btn"
                class="wa-action-btn"
                aria-label="Reiniciar chat"
                title="Reiniciar chat"
            >
                <i class="ph ph-arrows-counter-clockwise"></i>
            </button>
            <button
                id="wa-close-btn"
                class="wa-action-btn"
                aria-label="Cerrar chat"
                title="Cerrar"
            >
                <i class="ph ph-x"></i>
            </button>
        </div>
    </div>

    <!-- Messages Area -->
    <div id="wa-bot-messages" class="wa-bot-messages"></div>

    <!-- Input Area (Dynamic) -->
    <div id="wa-bot-input-area" class="wa-bot-input-area"></div>
</div>

<style is:global>
    /* --- Trigger Button (Reusing WhatsAppButton styles) --- */
    .whatsapp-float {
        position: fixed;
        right: 2rem;
        bottom: 2rem;
        z-index: 90;
        display: flex;
        align-items: center;
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        opacity: 0;
        transform: scale(0.5) translateY(20px);
        pointer-events: none;
    }

    .whatsapp-float.visible {
        opacity: 1;
        transform: scale(1) translateY(0);
        pointer-events: auto;
    }

    /* Ocultar trigger cuando el widget está abierto */
    .whatsapp-float.hidden-by-widget {
        opacity: 0 !important;
        transform: scale(0.5) translateY(20px) !important;
        pointer-events: none !important;
    }

    .whatsapp-icon {
        width: 3.5rem;
        height: 3.5rem;
        background: #25d366;
        color: white;
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        box-shadow: 0 10px 25px -5px rgba(37, 211, 102, 0.4);
        position: relative;
        z-index: 2;
        transition: all 0.3s ease;
    }

    .whatsapp-float:hover .whatsapp-icon {
        transform: rotate(10deg) scale(1.1);
        background: #20ba5a;
    }

    .whatsapp-tooltip {
        position: absolute;
        right: 100%;
        margin-right: 1rem;
        background: var(--color-surface);
        color: var(--color-secondary);
        padding: 0.5rem 1rem;
        border-radius: var(--radius-lg);
        font-size: 0.875rem;
        font-weight: 700;
        white-space: nowrap;
        box-shadow: var(--shadow-xl);
        border: 1px solid var(--color-line);
        opacity: 0;
        transform: translateX(10px);
        transition: all 0.3s ease;
        pointer-events: none;
    }

    .whatsapp-float:hover .whatsapp-tooltip {
        opacity: 1;
        transform: translateX(0);
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7);
        }
        70% {
            box-shadow: 0 0 0 15px rgba(37, 211, 102, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(37, 211, 102, 0);
        }
    }

    .whatsapp-float.visible .whatsapp-icon {
        animation: pulse 2s infinite;
    }

    /* --- Chat Widget --- */
    .wa-bot-widget {
        position: fixed;
        right: 2rem;
        bottom: 2rem;
        width: 360px;
        height: 500px;
        max-height: calc(100vh - 4rem);
        background: color-mix(in srgb, var(--color-surface) 80%, transparent);
        backdrop-filter: blur(12px);
        /* background: var(--color-surface); */
        border: 1px solid rgba(var(--color-accent-rgb), 0.08);
        border-radius: 1.5rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        z-index: 100;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        opacity: 0;
        transform: translateY(20px) scale(0.95);
        pointer-events: none;
        transition:
            all 0.4s cubic-bezier(0.16, 1, 0.3, 1),
            height 0.25s ease,
            border-radius 0.25s ease;
        transform-origin: bottom right;
    }

    .wa-bot-widget.open {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
    }

    /* Header */
    .wa-bot-header {
        background: var(--color-surface);
        padding: 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--color-line);
    }

    .wa-bot-profile {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .profile-img {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        background: var(--color-accent);
        color: var(--color-on-accent);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        box-shadow: 0 0 15px rgba(var(--color-accent-rgb), 0.4);
        animation: pulse-border 2s infinite;
    }

    @keyframes pulse-border {
        0% {
            box-shadow: 0 0 0 0 rgba(var(--color-accent-rgb), 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(var(--color-accent-rgb), 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(var(--color-accent-rgb), 0);
        }
    }

    .wa-bot-profile h4 {
        margin: 0;
        font-size: 1rem;
        color: var(--color-secondary);
        font-weight: 700;
    }

    .wa-bot-profile p {
        margin: 0;
        font-size: 0.75rem;
        color: #25d366;
        font-weight: 500;
    }

    .wa-bot-actions {
        display: flex;
        gap: 0.25rem;
    }

    .wa-action-btn {
        background: none;
        border: none;
        color: var(--color-muted);
        font-size: 1.25rem;
        cursor: pointer;
        padding: 0.5rem;
        transition: color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .wa-action-btn:hover {
        color: var(--color-secondary);
    }

    /* Messages Area */
    .wa-bot-messages {
        flex: 1;
        padding: 1.25rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background: color-mix(
            in srgb,
            var(--color-background),
            transparent 20%
        );
    }

    /* Scrollbar */
    .wa-bot-messages::-webkit-scrollbar {
        width: 6px;
    }
    .wa-bot-messages::-webkit-scrollbar-track {
        background: transparent;
    }
    .wa-bot-messages::-webkit-scrollbar-thumb {
        background: var(--color-line);
        border-radius: 10px;
    }

    /* Message Bubbles */
    .msg-bubble {
        max-width: 85%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        font-size: 0.9rem;
        line-height: 1.4;
        animation: zutro-pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)
            forwards;
        opacity: 0;
        transform: translateY(10px);
    }

    /* Cuando el bot se pone juguetón */
    .msg-bot strong {
        color: var(--color-accent);
        font-weight: 800;
    }

    @keyframes zutro-pop {
        0% {
            transform: scale(0.9) translateY(10px);
            opacity: 0;
        }
        50% {
            transform: scale(1.02);
        }
        100% {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
    }

    .msg-bot {
        align-self: flex-start;
        background: var(--color-subtle);
        border: 1px solid var(--color-line);
        color: var(--color-secondary);
        border-radius: 1.25rem 1.25rem 1.25rem 0.2rem;
        font-family: var(--font-mono, monospace);
        font-size: 0.85rem;
    }

    .msg-user {
        align-self: flex-end;
        background: var(--color-accent);
        color: var(--color-on-accent);
        border-radius: 1.25rem 1.25rem 0.2rem 1.25rem;
        font-weight: 500;
    }

    .typing-indicator {
        display: flex;
        gap: 0.25rem;
        padding: 0.5rem 0.75rem;
        align-items: center;
        height: 1.5rem;
    }

    .dot {
        width: 6px;
        height: 6px;
        background: var(--color-muted);
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out both;
    }

    .dot:nth-child(1) {
        animation-delay: -0.32s;
    }
    .dot:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes typing {
        0%,
        80%,
        100% {
            transform: scale(0);
        }
        40% {
            transform: scale(1);
        }
    }

    /* Input Area */
    .wa-bot-input-area {
        padding: 1rem;
        background: var(--color-primary);
        border-top: 1px solid var(--color-line);
    }

    .wa-input-group {
        display: flex;
        gap: 0.5rem;
    }

    .wa-input {
        flex: 1;
        background: var(--color-background);
        border: 1px solid var(--color-line);
        padding: 0.75rem 1rem;
        border-radius: var(--radius-full);
        color: var(--color-secondary);
        font-size: 16px; /* Prevent iOS auto-zoom on focus */
        outline: none;
        transition: border-color 0.2s;
    }

    .wa-input:focus {
        border-color: var(--color-accent);
    }

    .wa-send-btn {
        width: 2.75rem;
        height: 2.75rem;
        border-radius: 50%;
        background: var(--color-accent);
        color: var(--color-on-accent);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.25rem;
        transition:
            transform 0.2s,
            background-color 0.2s;
        flex-shrink: 0;
    }

    .wa-send-btn:hover {
        transform: scale(1.05);
    }

    /* Chips */
    .wa-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .wa-chip {
        border: 1px solid var(--color-accent);
        background: transparent;
        color: var(--color-accent);
        padding: 0.5rem 1rem;
        border-radius: var(--radius-full);
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .wa-chip:hover {
        background: var(--color-accent);
        color: var(--color-on-accent);
        transform: translateY(-2px);
    }

    .wa-cta-btn {
        width: 100%;
        background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
        color: white;
        border: none;
        padding: 0.875rem;
        border-radius: var(--radius-full);
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: background 0.2s;
        box-shadow: 0 10px 20px -5px rgba(37, 211, 102, 0.4);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .wa-cta-btn:hover {
        opacity: 0.9;
    }

    /* --- Conversational UI Improvements --- */
    .error-shake {
        animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
        border-color: #ff4b4b !important;
        color: #ff4b4b;
    }

    @keyframes shake {
        10%,
        90% {
            transform: translate3d(-1px, 0, 0);
        }
        20%,
        80% {
            transform: translate3d(2px, 0, 0);
        }
        30%,
        50%,
        70% {
            transform: translate3d(-4px, 0, 0);
        }
        40%,
        60% {
            transform: translate3d(4px, 0, 0);
        }
    }

    .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #ff3b30;
        color: white;
        font-size: 0.75rem;
        font-weight: bold;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid var(--color-surface);
        animation: bounceIn 0.5s 2s backwards;
    }

    @keyframes bounceIn {
        0% {
            transform: scale(0);
        }
        50% {
            transform: scale(1.2);
        }
        100% {
            transform: scale(1);
        }
    }

    /* --- MOBILE LOGIC --- */
    @media (max-width: 768px) {
        .whatsapp-float {
            right: 1.5rem;
            bottom: 7.5rem; /* Safely above StickyCTA */
        }

        .whatsapp-icon {
            width: 3rem;
            height: 3rem;
            font-size: 1.75rem;
        }

        .whatsapp-tooltip {
            display: none;
        }

        .wa-bot-widget {
            right: 1rem;
            left: 1rem;
            bottom: 7.5rem;
            width: auto;
            height: 400px; /* Un poco más bajo en mobile para dar espacio arriba */
        }

        .wa-bot-widget.fullscreen-mobile {
            height: 100dvh;
            max-height: 100dvh;
            border-radius: 0;
            bottom: 0;
            right: 0;
            left: 0;
            width: 100%;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .wa-bot-widget.fullscreen-mobile #wa-bot-messages {
            flex: 1;
            overflow-y: auto;
        }
    }
</style>

<script>
    import { initWhatsAppBot } from "./whatsapp-bot";

    document.addEventListener("astro:page-load", initWhatsAppBot);
    document.addEventListener("DOMContentLoaded", initWhatsAppBot);
</script>
