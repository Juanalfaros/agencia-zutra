---
import { Image } from "astro:assets";

interface Props {
  images: {
    src: ImageMetadata | string;
    alt: string;
  }[];
  id: string;
}

const { images, id } = Astro.props;
---

<dialog id={id} class="lightbox-dialog" aria-label="Galería de imágenes">
  <div class="lightbox-backdrop"></div>

  <div class="lightbox-container">
    {/* Botón Cerrar */}
    <button class="control-btn close-btn" aria-label="Cerrar galería">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 256 256"
        ><path
          fill="currentColor"
          d="M205.66 194.34a8 8 0 0 1-11.32 11.32L128 139.31l-66.34 66.35a8 8 0 0 1-11.32-11.32L116.69 128L50.34 61.66a8 8 0 0 1 11.32-11.32L128 116.69l66.34-66.35a8 8 0 0 1 11.32 11.32L139.31 128Z"
        ></path></svg
      >
    </button>

    {/* Flecha Izquierda */}
    <button class="control-btn nav-btn prev" aria-label="Imagen anterior">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 256 256"
        ><path
          fill="currentColor"
          d="M165.66 202.34a8 8 0 0 1-11.32 11.32l-80-80a8 8 0 0 1 0-11.32l80-80a8 8 0 0 1 11.32 11.32L91.31 128Z"
        ></path></svg
      >
    </button>

    {/* Área de visualización (Viewport) */}
    <div class="lightbox-viewport">
      <div class="lightbox-track">
        {
          images.map((img, index) => (
            <div
              class="lightbox-slide"
              data-index={index}
              aria-hidden={index !== 0}
            >
              <div class="image-wrapper">
                <div class="loader" />
                <Image
                  src={img.src as any}
                  alt={img.alt}
                  width={1920}
                  height={1080}
                  class="lightbox-image"
                  draggable="false"
                  loading={index === 0 ? "eager" : "lazy"}
                />
              </div>
            </div>
          ))
        }
      </div>
    </div>

    {/* Flecha Derecha */}
    <button class="control-btn nav-btn next" aria-label="Siguiente imagen">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 256 256"
        ><path
          fill="currentColor"
          d="M181.66 133.66l-80 80a8 8 0 0 1-11.32-11.32L164.69 128L90.34 53.66a8 8 0 0 1 11.32-11.32l80 80a8 8 0 0 1 0 11.32Z"
        ></path></svg
      >
    </button>

    {/* Contador */}
    <div class="lightbox-counter">
      <span class="current">1</span> / <span class="total">{images.length}</span
      >
    </div>
  </div>
</dialog>

<script is:inline define:vars={{ id, totalImages: images.length }}>
  class LightboxController {
    constructor(dialogId, total) {
      this.dialog = document.getElementById(dialogId);
      if (!this.dialog) return;

      this.total = total;
      this.currentIndex = 0;
      this.isOpen = false;

      // UI Elements
      this.track = this.dialog.querySelector(".lightbox-track");
      this.slides = this.dialog.querySelectorAll(".lightbox-slide");
      this.counter = this.dialog.querySelector(".current");

      // Touch state
      this.touchStartX = 0;
      this.touchEndX = 0;

      this.init();
    }

    init() {
      // Triggers externos (botones que abren el lightbox)
      document
        .querySelectorAll(`[data-lightbox-trigger="${this.dialog.id}"]`)
        .forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            const idx = parseInt(btn.dataset.index || "0");
            this.open(idx);
          });
        });

      // Controles internos
      this.dialog
        .querySelector(".close-btn")
        .addEventListener("click", () => this.close());
      this.dialog
        .querySelector(".prev")
        .addEventListener("click", () => this.prev());
      this.dialog
        .querySelector(".next")
        .addEventListener("click", () => this.next());

      // Click en backdrop para cerrar
      this.dialog.addEventListener("click", (e) => {
        if (
          e.target === this.dialog ||
          e.target.classList.contains("lightbox-backdrop")
        ) {
          this.close();
        }
      });

      // Teclado
      document.addEventListener("keydown", (e) => {
        if (!this.isOpen) return;
        if (e.key === "Escape") this.close();
        if (e.key === "ArrowLeft") this.prev();
        if (e.key === "ArrowRight") this.next();
      });

      // Gestos (Swipe)
      this.track.addEventListener(
        "touchstart",
        (e) => {
          this.touchStartX = e.changedTouches[0].screenX;
        },
        { passive: true },
      );

      this.track.addEventListener(
        "touchend",
        (e) => {
          this.touchEndX = e.changedTouches[0].screenX;
          this.handleSwipe();
        },
        { passive: true },
      );
    }

    handleSwipe() {
      const threshold = 50; // Mínimo píxeles para considerar swipe
      if (this.touchEndX < this.touchStartX - threshold) this.next();
      if (this.touchEndX > this.touchStartX + threshold) this.prev();
    }

    updateUI() {
      // Mover el track usando transform para alto rendimiento
      const percentage = -(this.currentIndex * 100);
      this.track.style.transform = `translateX(${percentage}%)`;

      // Actualizar contador
      if (this.counter) this.counter.textContent = this.currentIndex + 1;

      // Gestionar carga perezosa de imágenes adyacentes (opcional pero recomendado)
      this.slides.forEach((slide, idx) => {
        const isVisible = idx === this.currentIndex;
        slide.setAttribute("aria-hidden", !isVisible);
        // Pequeño efecto de escala en la imagen activa
        const img = slide.querySelector("img");
        if (img) {
          img.style.transform = isVisible ? "scale(1)" : "scale(0.95)";
          img.style.opacity = isVisible ? "1" : "0.5";
        }
      });
    }

    open(index = 0) {
      this.currentIndex = index;
      this.isOpen = true;
      this.updateUI();

      this.dialog.showModal();
      document.body.style.overflow = "hidden"; // Bloquear scroll página

      // Animación de entrada
      requestAnimationFrame(() => {
        this.dialog.setAttribute("data-state", "open");
      });
    }

    close() {
      this.dialog.setAttribute("data-state", "closed");
      this.isOpen = false;

      // Esperar a que termine la animación CSS (300ms) antes de cerrar nativamente
      setTimeout(() => {
        this.dialog.close();
        document.body.style.overflow = "";
      }, 300);
    }

    next() {
      this.currentIndex = (this.currentIndex + 1) % this.total;
      this.updateUI();
    }

    prev() {
      this.currentIndex = (this.currentIndex - 1 + this.total) % this.total;
      this.updateUI();
    }
  }

  // Inicialización compatible con View Transitions de Astro
  document.addEventListener("astro:page-load", () => {
    new LightboxController(id, totalImages);
  });

  // Fallback para carga inicial normal
  if (!window.lightboxInitialized) {
    new LightboxController(id, totalImages);
    window.lightboxInitialized = true;
  }
</script>

<style>
  /* Variables para fácil personalización */
  :root {
    --lb-anim-speed: 0.4s;
    --lb-ease: cubic-bezier(0.16, 1, 0.3, 1); /* Curva 'Out Expo' muy suave */
    --lb-bg: rgba(5, 5, 5, 0.95);
    --lb-ui-bg: rgba(255, 255, 255, 0.1);
    --lb-ui-hover: rgba(255, 255, 255, 0.2);
    --lb-text: #fff;
  }

  /* Reset del Dialog */
  .lightbox-dialog {
    padding: 0;
    border: none;
    background: transparent;
    width: 100vw;
    height: 100vh;
    max-width: 100vw;
    max-height: 100vh;
    margin: 0;
    overflow: hidden;
    opacity: 0;
    transition:
      opacity 0.3s ease,
      backdrop-filter 0.3s ease;
  }

  /* Estado Abierto (Animación de entrada) */
  .lightbox-dialog[data-state="open"] {
    opacity: 1;
  }

  .lightbox-dialog::backdrop {
    background: transparent; /* Manejamos el fondo manualmente para animarlo */
  }

  .lightbox-backdrop {
    position: absolute;
    inset: 0;
    background: var(--lb-bg);
    backdrop-filter: blur(10px); /* Efecto Glass */
    z-index: 0;
  }

  .lightbox-container {
    position: relative;
    width: 100%;
    height: 100%;
    z-index: 1;
    display: flex;
    flex-direction: column;
  }

  /* Viewport y Track (El corazón del slider) */
  .lightbox-viewport {
    flex: 1;
    width: 100%;
    height: 100%;
    overflow: hidden;
    position: relative;
  }

  .lightbox-track {
    display: flex;
    height: 100%;
    width: 100%;
    transition: transform var(--lb-anim-speed) var(--lb-ease);
    will-change: transform;
  }

  .lightbox-slide {
    flex: 0 0 100%; /* Cada slide ocupa el 100% del ancho */
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    box-sizing: border-box;
  }

  .image-wrapper {
    position: relative;
    max-width: 100%;
    max-height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* La Imagen */
  .lightbox-image {
    max-width: 100%;
    max-height: 85vh;
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: var(--radius-2xl);
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
    user-select: none;

    /* Animación interna de la imagen al cambiar slide */
    transition:
      transform 0.5s var(--lb-ease),
      opacity 0.4s ease;
    transform: scale(0.95);
    opacity: 0.5;
  }

  /* Loader Spinner */
  .loader {
    position: absolute;
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    z-index: -1; /* Detrás de la imagen */
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Controles (Botones) */
  .control-btn {
    position: absolute;
    background: var(--lb-ui-bg);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--lb-text);
    border-radius: 50%;
    padding: 12px;
    cursor: pointer;
    z-index: 10;
    transition: all 0.2s ease;
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    /* Evitar el "tap highlight" azul en móviles */
    -webkit-tap-highlight-color: transparent;
  }

  .control-btn:hover {
    background: var(--lb-ui-hover);
    transform: scale(1.05);
  }

  .control-btn:active {
    transform: scale(0.95);
  }

  .close-btn {
    top: 20px;
    right: 20px;
  }
  .prev {
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
  }
  .next {
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
  }

  /* Ajuste de hover para prev/next para mantener el centrado vertical */
  .prev:hover,
  .next:hover {
    transform: translateY(-50%) scale(1.1);
  }

  /* Contador */
  .lightbox-counter {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.6);
    padding: 6px 16px;
    border-radius: 20px;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    font-variant-numeric: tabular-nums;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    pointer-events: none;
  }

  /* Media Queries Responsive */
  @media (max-width: 768px) {
    .nav-btn {
      display: none; /* En móvil ocultamos flechas, usamos Swipe */
    }

    .lightbox-image {
      max-height: 80vh;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .close-btn {
      top: 15px;
      right: 15px;
      background: transparent; /* Más limpio en móvil */
    }
  }
</style>
