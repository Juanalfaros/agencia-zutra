---
interface Props {
  title: string;
  description: string;
  image?: string;
  type?: string;
  keywords?: string;
}

import SEO from "@/components/common/SEO.astro";
import JsonLD from "@/components/common/JsonLD.astro";
import CookieConsent from "@/components/common/CookieConsent.astro";
import PreviewIndicator from "@/components/common/PreviewIndicator.astro";
import { isPreviewEnabled } from "@/lib/contentful";
import "@/styles/main.css";
import "@phosphor-icons/web/regular";
import "@phosphor-icons/web/bold";
import "@phosphor-icons/web/duotone";
import "@phosphor-icons/web/fill";
import "@phosphor-icons/web/light";
import "@phosphor-icons/web/thin";

const { title, description, image, type, keywords } = Astro.props;

const GTM_ID = import.meta.env.PUBLIC_GTM_ID;
---

<!doctype html>
<html lang="es">
  <head>
    <SEO 
      title={title} 
      description={description} 
      image={image} 
      type={type} 
      keywords={keywords} 
    />
    <JsonLD />
    
    {/* GTM Script - Solo si existe ID */}

    {/* GTM Script - Solo si existe ID */}
    { GTM_ID && (
      <script is:inline define:vars={{ GTM_ID }}>
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer',GTM_ID);
      </script>
    )}

    <script is:inline>
      const getTheme = () => {
        if (
          typeof localStorage !== "undefined" &&
          localStorage.getItem("theme")
        ) {
          return localStorage.getItem("theme");
        }
        return window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "light";
      };
      document.documentElement.setAttribute("data-theme", getTheme());

      // Zutra: Random Accent Color Initialization
      (function() {
        const palettes = [
          { main: '#EFD319', hover: '#FACC15', onAccent: '#080501' }, // Amarillo
          { main: '#19EFB5', hover: '#15C999', onAccent: '#080501' }, // Verde Menta
          { main: '#FF0055', hover: '#D6004C', onAccent: '#ffffff' }, // Magenta
          { main: '#811DBC', hover: '#6A169E', onAccent: '#ffffff' }  // PÃºrpura
        ];
        const randomPalette = palettes[Math.floor(Math.random() * palettes.length)];
        const root = document.documentElement;
        
        root.style.setProperty('--accent-main', randomPalette.main);
        root.style.setProperty('--accent-hover', randomPalette.hover);
        root.style.setProperty('--color-accent', randomPalette.main);
        root.style.setProperty('--color-accent-hover', randomPalette.hover);
        root.style.setProperty('--color-on-accent', randomPalette.onAccent);
        
        const r = parseInt(randomPalette.main.slice(1, 3), 16);
        const g = parseInt(randomPalette.main.slice(3, 5), 16);
        const b = parseInt(randomPalette.main.slice(5, 7), 16);
        root.style.setProperty('--color-accent-rgb', `${r}, ${g}, ${b}`);
        
        // Zutra: Dynamic Favicon Update (Immediate)
        const updateFavicon = (color) => {
          const faviconLink = document.getElementById('dynamic-favicon');
          if (!faviconLink) return;

          const svgTemplate = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100.79 93.73">
              <defs><style>.cls-1{fill:${color};}.cls-2{fill:#fff8e0;}</style></defs>
              <g>
                <path class="cls-1" d="M74.68,42.11l-24.86,19.05c-.57.44-.9.89-.9,1.23s.1.44,1,.44h49.93c.64-4.63.93-9.92.93-15.97C100.79,7.58,88.36,0,50.4,0S0,7.58,0,46.86s12.43,46.87,50.4,46.87c23.86,0,37.64-3.01,44.58-14.99H29.78c-5.6,0-9.75-4.37-9.75-11.42,0-5.82,2.02-8.86,5.48-11.54l25.65-19.59c.56-.45.89-.79.89-1.01,0-.34-.34-.56-1.11-.56h-20.12c-4.78,0-8.66-3.88-8.66-8.66v-6.57h46.92c6.5,0,10.98,3.81,10.98,10.87,0,6.61-2.7,9.74-5.38,11.86Z"/>
                <path class="cls-2" d="M99.86,62.83c-.89,6.55-2.48,11.76-4.89,15.91H29.78c-5.6,0-9.75-4.37-9.75-11.42,0-5.82,2.02-8.86,5.48-11.54l25.65-19.59c.56-.45.89-.79.89-1.01,0-.34-.34-.56-1.11-.56h-20.12c-4.78,0-8.66-3.88-8.66-8.66v-6.57h46.92c6.5,0,10.98,3.81,10.98,10.87,0,6.61-2.7,9.74-5.38,11.86l-24.86,19.05c-.57.44-.9.89-.9,1.23s.1.44,1,.44h49.93Z"/>
              </g>
            </svg>`;

          const encodedSvg = encodeURIComponent(svgTemplate.trim());
          faviconLink.href = `data:image/svg+xml,${encodedSvg}`;
        };
        updateFavicon(randomPalette.main);

        console.log('Zutra: Accent color initialized in head:', randomPalette.main);
        window.__ZUTRA_ACCENT__ = randomPalette.main;
      })();
    </script>

    <link
      rel="icon"
      id="dynamic-favicon"
      href="/favicon.svg"
      type="image/svg+xml"
    />

    <link rel="stylesheet" href="https://use.typekit.net/dmw4nxz.css" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <!-- GTM NoScript -->
    { GTM_ID && (
      <noscript><iframe src={`https://www.googletagmanager.com/ns.html?id=${GTM_ID}`}
      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    )}

    <slot />
    
    <div id="bg-master" class="bg-master">
      <div class="bg-layer topo-layer"></div>
      <div class="bg-layer topo-layer-2"></div>
    </div>

    <CookieConsent />
    <PreviewIndicator />

    {isPreviewEnabled && (
      <script>
        import { ContentfulLivePreview } from '@contentful/live-preview';
        
        ContentfulLivePreview.init({
          locale: 'es-US',
          enableInspectorMode: true,
          enableLiveUpdates: true,
        });
      </script>
    )}

    <script>
      import "../scripts/main.js";
    </script>
  </body>
</html>
