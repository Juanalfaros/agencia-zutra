---
export const prerender = true;
import Layout from "../../layouts/Layout.astro";
import CaseHero from "../../components/portfolio/CaseHero.astro";
import CaseChallenge from "../../components/portfolio/CaseChallenge.astro";
import CaseExecution from "../../components/portfolio/CaseExecution.astro";
import CaseFeatures from "../../components/portfolio/CaseFeatures.astro";
import NextProjectNav from "../../components/portfolio/NextProjectNav.astro";
import { getEntries, getEntriesByField } from "@/lib/contentful";
import { adaptPortfolioCase } from "@/lib/contentful-adapters";
import type { ZutraCaseStudy } from "@/types/project-types";

export async function getStaticPaths() {
    try {
        const entries = await getEntries("portfolioCase", {
            order: "fields.order",
        });
        const portfolioCases = entries.items.map(adaptPortfolioCase);

        if (portfolioCases.length === 0) {
            return [];
        }

        return portfolioCases.map((project: ZutraCaseStudy) => ({
            params: { slug: project.slug },
            props: { project, allProjects: portfolioCases },
        }));
    } catch (error) {
        console.warn(
            "No portfolio cases available for static paths generation",
        );
        return [];
    }
}

const isPreview =
    import.meta.env.DEV &&
    Astro.cookies.get("contentful_preview")?.value === "true";
let { project, allProjects } = Astro.props as {
    project: ZutraCaseStudy;
    allProjects: ZutraCaseStudy[];
};

if (isPreview) {
    const slug = Astro.params.slug;
    const entries = await getEntriesByField(
        "portfolioCase",
        "slug",
        slug,
        true,
    );
    if (entries.items.length > 0) {
        project = adaptPortfolioCase(entries.items[0]);
    }

    const allEntries = await getEntries(
        "portfolioCase",
        { order: "fields.order" },
        true,
    );
    allProjects = allEntries.items.map(adaptPortfolioCase);
}

// Find next project for navigation
const currentIndex = allProjects.findIndex((c) => c.id === project.id);
const nextProject = allProjects[(currentIndex + 1) % allProjects.length];
const prevProject =
    allProjects[(currentIndex - 1 + allProjects.length) % allProjects.length];
---

<Layout
    title={`${project.title} â€” Portfolio Zutra`}
    description={project.description}
    image={project.featuredImage.src.src}
>
    <main class="case-study">
        <CaseHero project={project} />
        <hr class="divider" />

        <CaseChallenge project={project} />
        <hr class="divider" />

        <CaseExecution project={project} />
        <hr class="divider" />

        <CaseFeatures project={project} />

        <NextProjectNav nextProject={nextProject} prevProject={prevProject} />
    </main>
</Layout>

<style>
    .case-study {
        padding-top: 5rem;
    }
    .divider {
        width: 100%;
        border: 0;
        height: 1px;
        background-color: var(--color-line);
        margin: 0;
    }
</style>
