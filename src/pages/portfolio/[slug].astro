---
export const prerender = true;
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/common/Header.astro";
import Footer from "../../components/common/Footer.astro";
import StickyCTA from "../../components/common/StickyCTA.astro";
import CaseNavigation from "../../components/portfolio/CaseNavigation.astro";
import CaseHero from "../../components/portfolio/CaseHero.astro";
import CaseKeyInfo from "../../components/portfolio/CaseKeyInfo.astro";
import CaseChallenge from "../../components/portfolio/CaseChallenge.astro";
import CaseStrategy from "../../components/portfolio/CaseStrategy.astro";
import CaseExecution from "../../components/portfolio/CaseExecution.astro";
import CaseResults from "../../components/portfolio/CaseResults.astro";
import CaseFeatures from "../../components/portfolio/CaseFeatures.astro";
import CaseClosure from "../../components/portfolio/CaseClosure.astro";
import NextProjectNav from "../../components/portfolio/NextProjectNav.astro";
import { getEntries, getEntriesByField } from "@/lib/contentful";
import { adaptPortfolioCase } from "@/lib/contentful-adapters";
import type { ZutraCaseStudy } from "@/types/project-types";

export async function getStaticPaths() {
    const entries = await getEntries("portfolioCase", {
        order: "fields.order",
    });
    const portfolioCases = entries.items.map(adaptPortfolioCase);

    return portfolioCases.map((project: ZutraCaseStudy) => ({
        params: { slug: project.slug },
        props: { project, allProjects: portfolioCases },
    }));
}

const isPreview = Astro.cookies.get("contentful_preview")?.value === "true";
let { project, allProjects } = Astro.props as {
    project: ZutraCaseStudy;
    allProjects: ZutraCaseStudy[];
};

if (isPreview) {
    const slug = Astro.params.slug;
    const entries = await getEntriesByField(
        "portfolioCase",
        "slug",
        slug,
        true,
    );
    if (entries.items.length > 0) {
        project = adaptPortfolioCase(entries.items[0]);
    }

    const allEntries = await getEntries(
        "portfolioCase",
        { order: "fields.order" },
        true,
    );
    allProjects = allEntries.items.map(adaptPortfolioCase);
}

// Find next project for navigation
const currentIndex = allProjects.findIndex((c) => c.id === project.id);
const nextProject = allProjects[(currentIndex + 1) % allProjects.length];
---

<Layout
    title={`${project.title} â€” Portfolio Zutra`}
    description={project.description}
    image={project.featuredImage.src.src}
>
    <Header />

    <main class="case-study">
        <CaseNavigation />
        <CaseHero project={project} />
        <CaseKeyInfo project={project} />
        <CaseChallenge project={project} />
        <CaseStrategy project={project} />
        <CaseExecution project={project} />
        <CaseResults project={project} />
        <CaseFeatures project={project} />
        <CaseClosure project={project} />
        <NextProjectNav nextProject={nextProject} />
    </main>

    <StickyCTA />
    <Footer />
</Layout>

<style>
    .case-study {
        padding-top: 5rem;
    }
</style>
